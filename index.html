<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>كشفُ الغِطاءِ عن محاسنِ الأخطاءِ</title>

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@200;300;400;500;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'IBM Plex Sans Arabic',sans-serif}

:root{
--bg:#fbfbfd;
--text:#1d1d1f;
--sub:#6e6e73;
--bubble:#f2f2f7;
--card:#ffffff;
--shadow:0 12px 30px rgba(0,0,0,0.08);
--link:#0071e3;
}

:root.dark{
--bg:#111111;
--text:#f2f2f2;
--sub:#a1a1a6;
--bubble:#1c1c1e;
--card:#181818;
--link:#66aaff;
}

body{
background:var(--bg);
color:var(--text);
padding:80px 20px;
display:flex;
flex-direction:column;
align-items:center;
transition:.4s;
}

#dark-toggle{
position:absolute;
top:20px;
left:20px;
border:none;
background:#000;
color:#fff;
padding:8px 14px;
border-radius:14px;
cursor:pointer;
}

:root.dark #dark-toggle{
background:#eee;
color:#111;
}

header{
text-align:center;
margin-bottom:40px;
}

header h1{
font-size:1.4rem;
font-weight:500;
white-space:nowrap;
}

.container{
max-width:850px;
width:100%;
}

.message-node{
margin-bottom:18px;
}

.bubble{
background:var(--bubble);
padding:20px;
border-radius:20px;
box-shadow:var(--shadow);
cursor:pointer;
transition:.3s;
}

.label{
display:block;
font-size:.85rem;
color:var(--sub);
margin-bottom:6px;
}

.commentary{
display:none;
margin-top:14px;
padding:16px;
background:rgba(0,0,0,.03);
border-radius:16px;
}

:root.dark .commentary{
background:rgba(255,255,255,.05);
}

.message-node.active .commentary{
display:block;
}

.source-icon{
display:inline-block;
margin-top:18px;
font-size:.85rem;
color:var(--sub);
cursor:pointer;
}

.source-icon:hover{
color:var(--link);
}

.faq-node{
margin-top:25px;
padding:18px;
background:var(--bubble);
border-radius:18px;
cursor:pointer;
box-shadow:var(--shadow);
}

.faq-content{
display:none;
margin-top:10px;
color:var(--sub);
}

.faq-node.active .faq-content{
display:block;
}

#admin-panel{
display:none;
margin-bottom:40px;
padding:25px;
background:var(--card);
border-radius:20px;
box-shadow:var(--shadow);
}

#admin-panel input,
#admin-panel textarea,
#admin-panel select{
width:100%;
margin-bottom:10px;
padding:8px;
}

#admin-panel button{
padding:8px 14px;
cursor:pointer;
}

.sources-popup{
display:none;
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:var(--card);
padding:30px;
border-radius:20px;
box-shadow:0 20px 60px rgba(0,0,0,.3);
max-width:500px;
width:90%;
}

.sources-popup a{
display:block;
margin-bottom:10px;
color:var(--link);
text-decoration:none;
}
</style>
</head>
<body>

<button id="dark-toggle">الوضع الليلي</button>

<header>
<h1>كشفُ الغِطاءِ عن محاسنِ الأخطاءِ</h1>
</header>

<div class="container">

<div id="admin-panel">
<h3>لوحة الإدارة</h3>

<textarea id="admin-text" placeholder="النص"></textarea>

<select id="admin-side">
<option value="first">الطرفُ الأوّلُ</option>
<option value="other">الطرفُ الآخَرُ</option>
</select>

<select id="admin-gender">
<option value="male">وأنتَ</option>
<option value="female">وأنتِ</option>
</select>

<input id="admin-sources" placeholder="روابط المصادر (افصل بينهم بفاصلة ,)">
<button onclick="addMessage()">إضافة تعليق</button>

<hr style="margin:20px 0">

<input id="faq-q" placeholder="سؤال FAQ">
<textarea id="faq-a" placeholder="إجابة FAQ (بالقرآن فقط)"></textarea>
<button onclick="addFAQ()">إضافة FAQ</button>
</div>

<div id="messages"></div>
<div id="faq-container"></div>

</div>

<div id="sources-popup" class="sources-popup">
<h3>المصادر</h3>
<div id="sources-list"></div>
<button onclick="closeSources()">إغلاق</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* ===== YOUR REAL CONFIG ===== */

const firebaseConfig = {
  apiKey: "AIzaSyCRkIxb8WPAXqbgb296HNke9QOqCwcB8Kg",
  authDomain: "advice-da46c.firebaseapp.com",
  projectId: "advice-da46c",
  storageBucket: "advice-da46c.firebasestorage.app",
  messagingSenderId: "292998890591",
  appId: "1:292998890591:web:06035356df1e4fb0f087ea",
  measurementId: "G-GFLDRBLTCF"
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "tmtmcpe@gmail.com";

/* ===== Hidden Admin Login ===== */

const params = new URLSearchParams(window.location.search);
if (params.get("admin") === "moon") {
  const email = prompt("Email:");
  const pass = prompt("Password:");
  signInWithEmailAndPassword(auth, email, pass)
    .catch(() => alert("Login failed"));
}

onAuthStateChanged(auth, user => {
  if (user && user.email === ADMIN_EMAIL) {
    document.getElementById("admin-panel").style.display = "block";
  }
});

/* ===== Add Comment ===== */

window.addMessage = async function() {
  const user = auth.currentUser;
  if (!user || user.email !== ADMIN_EMAIL) return;

  await addDoc(collection(db,"messages"),{
    text: admin-text.value,
    side: admin-side.value,
    gender: admin-gender.value,
    sources: admin-sources.value.split(","),
    created: Date.now()
  });

  location.reload();
};

/* ===== Add FAQ ===== */

window.addFAQ = async function(){
  const user = auth.currentUser;
  if (!user || user.email !== ADMIN_EMAIL) return;

  await addDoc(collection(db,"faq"),{
    q: faq-q.value,
    a: faq-a.value
  });

  location.reload();
};

/* ===== Load Content ===== */

function toggleNode(el){ el.classList.toggle("active"); }
function toggleFAQ(el){ el.classList.toggle("active"); }

window.showSources=function(el){
 const list=document.getElementById("sources-list");
 list.innerHTML="";
 const data=el.parentElement.dataset.sources;
 if(data){
  data.split(",").forEach(url=>{
   const a=document.createElement("a");
   a.href=url.trim();
   a.target="_blank";
   a.textContent=url.trim();
   list.appendChild(a);
  });
 }
 document.getElementById("sources-popup").style.display="block";
}

window.closeSources=function(){
 document.getElementById("sources-popup").style.display="none";
}

async function load(){
 const snap=await getDocs(collection(db,"messages"));
 snap.forEach(doc=>{
  const d=doc.data();
  const side=d.side==="first"?"الطرفُ الأوّلُ":"الطرفُ الآخَرُ";
  const gender=d.gender==="male"?"وأنتَ":"وأنتِ";
  const node=document.createElement("div");
  node.className="message-node";
  node.innerHTML=`
   <div class="bubble" onclick="toggleNode(this.parentElement)">
    <span class="label">${side} — ${gender}</span>
    ${d.text}
   </div>
   <div class="commentary" data-sources="${(d.sources||[]).join(",")}">
    <span class="source-icon" onclick="showSources(this)">المصادر</span>
   </div>
  `;
  document.getElementById("messages").prepend(node);
 });

 const faqSnap=await getDocs(collection(db,"faq"));
 faqSnap.forEach(doc=>{
  const f=doc.data();
  const node=document.createElement("div");
  node.className="faq-node";
  node.innerHTML=`
   <div onclick="toggleFAQ(this.parentElement)">${f.q}</div>
   <div class="faq-content">${f.a}</div>
  `;
  document.getElementById("faq-container").appendChild(node);
 });
}
load();

/* ===== Dark Mode ===== */

dark-toggle.onclick=()=>{
 document.documentElement.classList.toggle("dark");
};
</script>

</body>
</html>
